import{Server as SocketServer}from"node:net";import os from"node:os";import Path from"node:path";import{ulid}from"ulid";import{getSocketAddress,getSocketRemoteAddress,promiseEvent}from"#util";import OClient from"./client.js";export class Server{logger;handle;opts;socket;sockets=new Set;clients=new Set;meta={id:ulid(),name:`Server`};path=``;limit;constructor(i,a={},o={}){this.logger=i,this.handle=a,this.opts=o,o.limit&&(this.limit=o.limit),o.path&&(this.path=o.path),o.socket instanceof SocketServer?this.socket=o.socket:this.socket=new SocketServer(o.socket),this.socket.on(`listening`,()=>{this.logger.info(`Socket 服务器已监听在`,getSocketAddress(this.socket))}).on(`connection`,e=>{if(this.limit&&this.sockets.size>=this.limit)return this.logger.warn(`连接数已达上限，已断开1个连接，剩余${this.sockets.size}个连接`),e.destroy();new Client(this.logger,this.handle,this,e,o)}).on(`error`,e=>this.logger.error(e)).on(`close`,()=>{this.logger.info(`Socket 服务器已关闭`)})}listen(e=this.path,...o){if(e.startsWith(`tcp://`)){let[i,a]=e.slice(6).split(`:`);this.socket.listen(Number(a),i);return}switch(e=Path.resolve(e),os.type()){case`Linux`:e=`\0${e}`;break;case`Windows_NT`:e=Path.join(`\\\\?\\pipe`,e);break}return this.socket.listen(e,...o),promiseEvent(this.socket,`listening`,`error`)}add(e){this.sockets.add(e.event),this.clients.add(e)}del(e){this.sockets.delete(e.event),this.clients.delete(e)}listener={connected(){this.server.add(this),this.onconnected(`共${this.server.sockets.size}个连接`)},close(){this.server.del(this),this.onclose(`剩余${this.server.sockets.size}个连接`)}};async close(){return await Promise.allSettled([...this.clients].map(e=>e.close())),this.socket.close(),promiseEvent(this.socket,`close`,`error`)}}export default Server;class Client extends OClient{logger;server;constructor(e,i,a,o,s){let l=getSocketRemoteAddress(o);for(let c in super(e,i,{...s,socket:o}),this.logger=e,this.server=a,this.logger=this.server.logger,Object.assign(this.meta.local,a.meta),a.listener)this.listener[c]=a.listener[c].bind(this);this.onconnect().catch(e=>{this.logger.error(...l,`连接错误`,e),this.forceClose()})}}