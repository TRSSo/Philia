import fs from"node:fs/promises";import path from"node:path";import util from"node:util";import{Chalk}from"chalk";export const chalk=new Chalk({level:3});export function makeError(e,...b){return Object.assign(Error(e),...b)}export function findArrays(e,b){return e.find(e=>b.includes(e))}export function StringOrNull(e){return typeof e==`object`&&typeof e.toString!=`function`?`[object null]`:String(e)}export function StringOrBuffer(e,b=!1){let x=String(e);return x.includes(`�`)?b?`base64://${e.toString(`base64`)}`:e:x}export function getCircularReplacer(){let e=[];return function(b,x){switch(typeof x){case`function`:return String(x);case`object`:if(x===null)return null;if(x instanceof Map||x instanceof Set)return Array.from(x);if(x instanceof Error)return x.stack;if(x.type===`Buffer`&&Array.isArray(x.data))try{return StringOrBuffer(Buffer.from(x),!0)}catch{}break;default:return x}for(;e.length>0&&e.at(-1)!==this;)e.pop();return e.includes(x)?`[Circular ${StringOrNull(x)}]`:(e.push(x),x)}}export function toJSON(e,b){switch(typeof e){case`string`:return e;case`function`:return String(e);case`object`:if(e instanceof Error)return e.stack||StringOrNull(e);if(Buffer.isBuffer(e))return StringOrBuffer(e,!0)}try{return JSON.stringify(e,getCircularReplacer(),b)||StringOrNull(e)}catch{return StringOrNull(e)}}export async function toBuffer(x,S={}){if(Buffer.isBuffer(x))return x;if(x=String(x),x.startsWith(`base64://`))x=Buffer.from(x.replace(`base64://`,``),`base64`);else if(x.match(/^https?:\/\//)){if(S.http)return x;x=Buffer.from(await(await fetch(x,S)).arrayBuffer())}else{let C=x.replace(/^file:\/\//,``);if(await fs.stat(C).catch(()=>!1))return S.path?`file://${path.resolve(C)}`:fs.readFile(C)}throw makeError(`数据转换失败`,{data:x})}export function Loging(e,b={}){b.string&&typeof e==`string`||(e=b?util.inspect(e,{depth:5,colors:!0,showHidden:!0,showProxy:!0,getters:!0,breakLength:100,maxArrayLength:100,maxStringLength:1e3,...b}):StringOrNull(e));let S=b.length||1e4;return e.length>S&&(e=`${e.slice(0,S)}${chalk.gray(`... ${e.length-S} more characters`)}`),e}export function getAllProps(e,b=new Set){if([Object.prototype,void 0,null].includes(e))return b;for(let x of Object.getOwnPropertyNames(e))b.add(x);return getAllProps(Object.getPrototypeOf(e),b)}export function promiseEvent(e,b,x,S){let C=Promise.withResolvers();return e.once(b,C.resolve),x&&e.once(x,C.reject),S&&(C.timeout=setTimeout(()=>C.reject(makeError(`等待事件超时`,{event:e,resolve:b,reject:x,timeout:S})),S)),C.promise.finally(()=>{e.off(b,C.resolve),x&&e.off(x,C.reject),S&&clearTimeout(C.timeout)})}export function isSubObj(e,b,x=1,S=!1){if(x===0)return!1;for(let C in e){if(e[C]===void 0||e[C]===b[C])continue;if(typeof e[C]==`object`&&e[C]!==null&&typeof b[C]==`object`&&b[C]!==null){if(!(S?isEqualObj:isSubObj)(e[C],b[C],x-1))return!1}else return!1}return!0}export function isEqualObj(e,b,x){return Object.keys(e).length===Object.keys(b).length?isSubObj(e,b,x,!0):!1}export function modeMatch(e,b){let x=Array.isArray(e.list)?e.list:[e.list];switch(e.mode){case`exclude`:return!x.includes(b);case`regexp`:return new RegExp(x.join(`|`)).test(b);default:return x.includes(b)}}export function getDate(e=new Date){let b=e.getFullYear(),x=String(e.getMonth()+1).padStart(2,`0`),S=String(e.getDate()).padStart(2,`0`);return`${b}-${x}-${S}`}export function getTime(e=new Date){let b=String(e.getHours()).padStart(2,`0`),x=String(e.getMinutes()).padStart(2,`0`),S=String(e.getSeconds()).padStart(2,`0`),C=String(e.getMilliseconds()).padStart(3,`0`);return`${b}:${x}:${S}.${C}`}export function getDateTime(e=new Date){return`${getDate(e)} ${getTime(e)}`}export function getTimeDiff(e,b=Date.now()){let x=b-e,S=x%1e3;x=Math.floor(x/1e3);let C=x%60;x=Math.floor(x/60);let w=x%60;x=Math.floor(x/60);let T=x%24;x=Math.floor(x/24);let E=``;return x&&(E+=`${x}天`),T&&(E+=`${T}时`),w&&(E+=`${w}分`),C&&(E+=`${C}秒`),S&&(E+=S),E||`0秒`}export function getCodeDir(){return path.relative(process.cwd(),path.dirname(import.meta.dirname))}export function getRootDir(){return path.relative(process.cwd(),path.dirname(path.dirname(import.meta.dirname)))}export function getSocketAddress(e){let b=e.address();return typeof b==`object`&&b.family?`${b.family.endsWith(`6`)?`[${b.address}]`:b.address}:${b.port}`:b}export function getSocketRemoteAddress(e){return e.remoteFamily?[`${e.remoteFamily.endsWith(`6`)?`[${e.remoteAddress}]`:e.remoteAddress}:${e.remotePort}`]:[]}export function getRequestInfo(e){return[`http://${e.headers[`x-forwarded-host`]||e.headers.host||`${getSocketAddress(e.socket)}`}${e.url}`,...getSocketRemoteAddress(e.socket)]}