import fs from"node:fs/promises";import path from"node:path";import util from"node:util";import{Chalk}from"chalk";export const chalk=new Chalk({level:3});export function makeError(e,...x){return Object.assign(Error(e),...x)}export function findArrays(e,x){return e.find(e=>x.includes(e))}export function StringOrNull(e){return typeof e==`object`&&typeof e.toString!=`function`?`[object null]`:String(e)}export function StringOrBuffer(e,x=!1){let S=String(e);return S.includes(`�`)?x?`base64://${e.toString(`base64`)}`:e:S}export function getCircularReplacer(){let e=[];return function(x,S){switch(typeof S){case`function`:return String(S);case`object`:if(S===null)return null;if(S instanceof Map||S instanceof Set)return Array.from(S);if(S instanceof Error)return S.stack;if(S.type===`Buffer`&&Array.isArray(S.data))try{return StringOrBuffer(Buffer.from(S),!0)}catch{}break;default:return S}for(;e.length>0&&e.at(-1)!==this;)e.pop();return e.includes(S)?`[Circular ${StringOrNull(S)}]`:(e.push(S),S)}}export function toJSON(e,x){switch(typeof e){case`string`:return e;case`function`:return String(e);case`object`:if(e instanceof Error)return e.stack||StringOrNull(e);if(Buffer.isBuffer(e))return StringOrBuffer(e,!0)}try{return JSON.stringify(e,getCircularReplacer(),x)||StringOrNull(e)}catch{return StringOrNull(e)}}export async function toBuffer(S,C={}){if(Buffer.isBuffer(S))return S;if(S=String(S),S.startsWith(`base64://`))S=Buffer.from(S.replace(`base64://`,``),`base64`);else if(S.match(/^https?:\/\//)){if(C.http)return S;S=Buffer.from(await(await fetch(S,C)).arrayBuffer())}else{let w=S.replace(/^file:\/\//,``);if(await fs.stat(w).catch(()=>!1))return C.path?`file://${path.resolve(w)}`:fs.readFile(w)}throw makeError(`数据转换失败`,{data:S})}export function Loging(e,x={}){x.string&&typeof e==`string`||(e=x?util.inspect(e,{depth:5,colors:!0,showHidden:!0,showProxy:!0,getters:!0,breakLength:100,maxArrayLength:100,maxStringLength:1e3,...x}):StringOrNull(e));let C=x.length||1e4;return e.length>C&&(e=`${e.slice(0,C)}${chalk.gray(`... ${e.length-C} more characters`)}`),e}export function getAllProps(e,x=new Set){if([Object.prototype,void 0,null].includes(e))return x;for(let S of Object.getOwnPropertyNames(e))x.add(S);return getAllProps(Object.getPrototypeOf(e),x)}export function promiseEvent(e,x,S,C){let w=Promise.withResolvers();return e.once(x,w.resolve),S&&e.once(S,w.reject),C&&(w.timeout=setTimeout(()=>w.reject(makeError(`等待事件超时`,{event:e,resolve:x,reject:S,timeout:C})),C)),w.promise.finally(()=>{e.off(x,w.resolve),S&&e.off(S,w.reject),C&&clearTimeout(w.timeout)})}export function isSubObj(e,x,S=1,C=!1){if(S===0)return!1;for(let w in e){if(e[w]===void 0||e[w]===x[w])continue;if(typeof e[w]==`object`&&e[w]!==null&&typeof x[w]==`object`&&x[w]!==null){if(!(C?isEqualObj:isSubObj)(e[w],x[w],S-1))return!1}else return!1}return!0}export function isEqualObj(e,x,S){return Object.keys(e).length===Object.keys(x).length?isSubObj(e,x,S,!0):!1}export function modeMatch(e,x){let S=Array.isArray(e.list)?e.list:[e.list];switch(e.mode){case`exclude`:return!S.includes(x);case`regexp`:return new RegExp(S.join(`|`)).test(x);default:return S.includes(x)}}export function getDate(e=new Date){let x=e.getFullYear(),S=String(e.getMonth()+1).padStart(2,`0`),C=String(e.getDate()).padStart(2,`0`);return`${x}-${S}-${C}`}export function getTime(e=new Date){let x=String(e.getHours()).padStart(2,`0`),S=String(e.getMinutes()).padStart(2,`0`),C=String(e.getSeconds()).padStart(2,`0`),w=String(e.getMilliseconds()).padStart(3,`0`);return`${x}:${S}:${C}.${w}`}export function getDateTime(e=new Date){return`${getDate(e)} ${getTime(e)}`}export function getTimeDiff(e,x=Date.now()){let S=x-e,C=S%1e3;S=Math.floor(S/1e3);let w=S%60;S=Math.floor(S/60);let T=S%60;S=Math.floor(S/60);let E=S%24;S=Math.floor(S/24);let D=``;return S&&(D+=`${S}天`),E&&(D+=`${E}时`),T&&(D+=`${T}分`),w&&(D+=`${w}秒`),C&&(D+=C),D||`0秒`}export function getCodeDir(){return path.relative(process.cwd(),path.dirname(import.meta.dirname))}export function getRootDir(){return path.relative(process.cwd(),path.dirname(path.dirname(import.meta.dirname)))}export function getProjectDir(e=``,S=``){return path.relative(process.cwd(),path.join(path.dirname(path.dirname(import.meta.dirname)),`Project`,e,S))}export function getSocketAddress(e){let x=e.address();return typeof x==`object`&&x.family?`${x.family.endsWith(`6`)?`[${x.address}]`:x.address}:${x.port}`:x}export function getSocketRemoteAddress(e){return e.remoteFamily?[`${e.remoteFamily.endsWith(`6`)?`[${e.remoteAddress}]`:e.remoteAddress}:${e.remotePort}`]:[]}export function getRequestInfo(e){return[`http://${e.headers[`x-forwarded-host`]||e.headers.host||`${getSocketAddress(e.socket)}`}${e.url}`,...getSocketRemoteAddress(e.socket)]}