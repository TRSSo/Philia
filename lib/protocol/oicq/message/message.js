import querystring from"node:querystring";import{lock}from"../common.js";import{PhiliaToOICQ}from"./converter.js";export class Message{c;event;parsed;get user_id(){return this.sender.user_id}get nickname(){return this.sender?.card||this.sender?.nickname||``}post_type=`message`;time;message=[];raw_message=``;font;message_id;seq;rand;sender;source;deserialize(e){switch(e.scene){case`group`:return new GroupMessage(this.c,e);default:return new PrivateMessage(this.c,e)}}constructor(e,i){this.c=e,this.event=i,lock(this,`c`),this.sender={user_id:i.user.id,nickname:i.user.name,...i.user},this.time=i.time,this.message_id=i.id,this.seq=i.raw?.seq||this.message_id,this.rand=i.raw?.rand||0,this.font=i.raw?.font||`unknown`,this.raw_message=i.summary,this.parsed=new PhiliaToOICQ(this.c,i.message),lock(this,`parsed`)}async parse(){return await this.parsed.convert(),this.message=this.parsed.after,this.raw_message??=this.parsed.brief,this.parsed.source&&(this.source=this.parsed.source),this}serialize(){return JSON.stringify(this.event)}toString(){return this.parsed.content}toJSON(e){return Object.fromEntries(Object.keys(this).filter(n=>typeof this[n]!=`function`&&!e.includes(n)).map(e=>[e,this[e]]))}toCqcode(){let n={"&":`&amp;`,",":`&#44;`,"[":`&#91;`,"]":`&#93;`},r=``;return this.source&&(r+=`[CQ:reply,id=${this.source.message_id}]`),(this.message||[]).forEach(i=>{if(i.type===`text`){r+=i.text;return}let a=querystring.stringify(i,`,`,`=`,{encodeURIComponent:e=>e.replace(new RegExp(Object.keys(n).join(`|`),`g`),(e=>n[e]||``))});r+=`[CQ:${i.type}${a?`,`:``}${a}]`}),r}}export class PrivateMessage extends Message{message_type=`private`;sub_type=`friend`;from_id;to_id;friend;deserialize(e){return new PrivateMessage(this.c,e)}constructor(e,n){super(e,n),this.from_id=n.is_self?this.c.uin:n.user.id,this.to_id=n.is_self?n.user.id:this.c.uin,this.friend=e.pickFriend(this.user_id)}reply(e,n=!1){return this.friend.sendMsg(e,n?this:void 0)}}export class GroupMessage extends Message{message_type=`group`;sub_type=`normal`;group_id;group_name;atme;atall;group;member;deserialize(e){return new GroupMessage(this.c,e)}constructor(e,n){super(e,n),this.group_id=n.group.id,this.group_name=n.group.name,this.atme=this.parsed.atme,this.atall=this.parsed.atall,this.group=e.pickGroup(this.group_id),this.member=e.pickMember(this.group_id,this.user_id)}recall(){return this.group.recallMsg(this)}reply(e,n=!1){return this.group.sendMsg(e,n?this:void 0)}}