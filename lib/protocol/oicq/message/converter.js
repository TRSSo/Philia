import fs from"node:fs/promises";import{modeMatch}from"#util";import{lock}from"../common.js";import{ExtendArray,segment}from"./elements.js";export class OICQtoPhilia{c;before;after=[];length=0;brief=``;response;constructor(e,i,o){this.c=e,lock(this,`c`),o&&this.quote(o),this.before=Array.isArray(i)?i:[i]}async convert(){for(let e of this.before)typeof e==`object`?typeof this[e.type]==`function`?await this[e.type](e):ExtendArray.includes(e.type)?this.extend(e):this._text(e):this._text(e);return this.after}extend(e){this.after.push({type:`extend`,extend:`OICQ.${e.type}`,data:e}),this.brief+=`[${e.type}: ${e}]`}platform(e){this.after.push(e),this.brief+=`[${e.type}: ${e.list} ${e}]`}_text(e,i){let a={type:`text`,data:String(e)};a.data.length&&(i&&(a.markdown=i),this.after.push(a),this.length+=a.data.length,this.brief+=a.data)}text(e){this._text(e.text,e.markdown)}at(e){let{qq:i,text:a=``}=e;switch(i){case`user`:if(i=String(i),!a){let e;!this.c.dm&&this.c.target&&(e=this.c.client.gml.get(this.c.target)?.get(i)),e??=this.c.client.fl.get(i),e&&(a=e.card||e.nickname)}if(e.dummy)return this._text(`@${a}`);this.brief+=`[提及: ${a}(${i})]`,this.after.push({type:`mention`,data:`user`,id:i,name:a});break;case`all`:this.brief+=`[提及全体成员]`,this.after.push({type:`mention`,data:`all`});break}}async _prepareFile(i){let a={raw:{...i},type:i.type,data:`binary`};if(i.fid)a.data=`id`,a.id=i.fid;else if(Buffer.isBuffer(i.file))a.binary=i.file,delete a.raw.file;else if(i.file.startsWith(`base64://`))a.binary=Buffer.from(i.file.replace(`base64://`,``),`base64`),delete a.raw.file;else if(i.file.match(/^https?:\/\//))a.data=`url`,a.url=i.file;else{let o=i.file.replace(/^file:\/\//,``);await fs.stat(o).catch(()=>!1)?a.binary=await fs.readFile(o):(a.data=`path`,a.path=o)}return a}async file(e){this.after.push(await this._prepareFile(e)),this.brief+=`[文件]`}async image(e){this.after.push(await this._prepareFile(e)),this.brief+=`[图片]`}async record(e){this.after.push(await this._prepareFile({...e,type:`voice`})),this.brief+=`[语音]`}async video(e){this.after.push(await this._prepareFile(e)),this.brief+=`[视频]`}async node(e){this.response=await this.c.sendForwardMsg(e.data)}markdown(e){this.after.push({type:`text`,data:e.content,markdown:e.content}),this.brief+=`[Markdown]`}_button(e){let i={QQBot:e,text:e.render_data.label,clicked_text:e.render_data.visited_label};switch(e.action.type){case 0:i.link=e.action.data;break;case 1:i.callback=e.action.data;break;case 2:i.input=e.action.data,i.send=e.action.enter;break}return e.action.permission&&(e.action.permission.type===1?i.permission=`admin`:i.permission=e.action.permission.specify_user_ids),i}button(e){let i=e.data||e.content?.rows.map(e=>e.buttons.map(this._button.bind(this)))||[];this.after.push({type:`button`,data:i}),this.brief+=`[按钮]`}reply(e){this.after.push({type:`reply`,data:e.id,summary:e.text}),this.brief+=`[提及: ${e.text?`${e.text}(${e.id})`:e.id}]`}quote(e){e.message_id&&this.reply({id:e.message_id,text:e.raw_message||e.message})}}export class PhiliaToOICQ{c;before;after=[];brief=``;content=``;source;atme=!1;atall=!1;constructor(e,i){this.c=e,lock(this,`c`),this.before=Array.isArray(i)?i:[i]}async convert(){for(let e of this.before)typeof e==`object`&&typeof this[e.type]==`function`?await this[e.type](e):this.after.push(segment.text(e))}text(e){this.after.push(segment.text(e.data,e.markdown)),this.brief+=e.data}mention(e){if(e.data===`all`){this.after.push(segment.at(`all`)),this.brief+=`@全体成员`,this.atall=!0;return}this.after.push(segment.at(e.id,e.name)),this.brief+=e.name?`@${e.name}(${e.id})`:`@${e.id}`,e.id===this.c.uin&&(this.atme=!0)}async reply(e){this.after.push(segment.reply(e.data,e.summary)),this.brief+=e.summary?`[回复: ${e.summary}(${e.data})]`:`[回复: ${e.data}]`;let i=await this.c.api.getMsg({id:e.data});this.source={...i,user_id:i.user.id,message_id:i.id}}_button(e){if(e.QQBot)return e.QQBot;let i={id:e.id,render_data:{label:e.text,visited_label:e.clicked_text||``}};if(e.input)i.action={type:2,permission:{type:2},data:e.input,enter:e.send};else if(e.callback)i.action={type:1,permission:{type:2}};else if(e.link)i.action={type:0,permission:{type:2},data:e.link};else return!1;return e.permission&&(e.permission===`admin`?i.action.permission.type=1:(i.action.permission.type=0,Array.isArray(e.permission)||(e.permission=[e.permission]),i.action.permission.specify_user_ids=e.permission)),i}button(e){this.after.push(Object.assign(e,segment.button(e.data.map(e=>e.map(this._button.bind(this)))))),this.brief+=`[按钮]`}extend(e){e.extend.startsWith(`OICQ.`)?(this.after.push(e.data),this.brief+=`[${e.data.type}: ${e.data}]`):(this.after.push(e),this.brief+=`[${e.extend} 扩展消息: ${e.data}]`)}platform(e){this.brief+=`[${e.list}(${e.mode}) 平台消息: ${e.data}]`,modeMatch(e,`OICQ`)?Array.isArray(e.data)?this.after.push(...e.data):this.after.push(e.data):this.after.push(e)}async _file(e,i){switch(i.data){case`id`:return this._file(e,await this.c.api.getFile({id:i.id}));case`path`:case`binary`:break;case`url`:this.after.push({...i,type:e});break}}file(e){return this.brief+=e.summary??`[文件: ${e.name}]`,this._file(`file`,e)}image(e){return this.brief+=e.summary??`[图片: ${e.name}]`,this._file(`image`,e)}voice(e){return this.brief+=e.summary??`[语音: ${e.name}]`,this._file(`record`,e)}audio(e){return this.brief+=e.summary??`[音频: ${e.name}]`,this._file(`file`,e)}video(e){return this.brief+=e.summary??`[视频: ${e.name}]`,this._file(`video`,e)}}