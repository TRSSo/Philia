import events from"node:events";import*as Connect from"#connect";import{getLogger}from"#logger";import{createAPI}from"#protocol/common";import{promiseEvent}from"#util";import{timestamp}from"./common.js";import{Friend,User}from"./contact/friend.js";import{Group}from"./contact/group.js";import{Member}from"./contact/member.js";import{OnlineStatus}from"./contact/types.js";import Handle from"./event/handle.js";import{OICQtoPhilia}from"./message/index.js";export class Client extends events{uin=``;pickGroup=Group.as.bind(this);pickUser=User.as.bind(this);pickFriend=Friend.as.bind(this);pickMember=Member.as.bind(this);logger;config;get[Symbol.toStringTag](){return`OicqClient`}fl=new Map;sl=new Map;gl=new Map;gml=new Map;blacklist=new Set;classes=new Map;self_info={id:``,name:``};version_info={};status=OnlineStatus.Offline;get nickname(){return this.self_info.name}get sex(){return this.self_info.sex}get age(){return this.self_info.age}get apk(){return this.version_info.proto}statistics={start_time:timestamp(),lost_times:0,recv_pkt_cnt:0,sent_pkt_cnt:0,lost_pkt_cnt:0,recv_msg_cnt:0,sent_msg_cnt:0,msg_cnt_per_min:0,remote_ip:``,remote_port:0,ver:``};handle=new Handle(this);api;client;isOnline(){return this.client?.open}path;logout(){return this.client.close()}writeUni(...e){return this.api.writeUni(e)}sendOidb(...e){return this.api.sendOidb(e)}sendPacket(...e){return this.api.sendPacket(e)}sendUni(...e){return this.api.sendUni(e)}sendOidbSvcTrpcTcp(...e){return this.api.sendOidbSvcTrpcTcp(e)}bkn;cookies;get stat(){return this.statistics}connected_fn=this.online.bind(this);closed_fn=()=>this.em(`system.offline.network`,{message:`连接断开`});constructor(e,m){super(),e instanceof Connect.Common.Client?(this.client=e,this.client.handle.setMap(this.handle),this.api=createAPI(this.client),this.client.connected_fn=this.connected_fn,this.client.closed_fn=this.closed_fn):typeof e==`object`?m=e:this.uin=String(e),this.logger=m?.logger??getLogger(`oicq`),this.config={ignore_self:!0,cache_group_member:!0,reconn_interval:5,...m}}login(e,d){return this.isOnline()?this.online():(this.uin?d=e||this.path:this.uin=String(e),this.path=d,this.connect()),promiseEvent(this,`system.online`,`system.login.error`)}connect(e=this.path){return e?(this.logger.mark(`正在连接`,e),this.client=/^(http|ws)s?:\/\//.test(e)?new Connect.WebSocket.Client(this.logger,this.handle,{path:e,connected_fn:this.connected_fn,closed_fn:this.closed_fn}):this.client=new Connect.Socket.Client(this.logger,this.handle,{path:e,connected_fn:this.connected_fn,closed_fn:this.closed_fn}),this.client.logger=this.logger,this.api=createAPI(this.client),this.client.connect()):this.em(`system.login.error`,Error(`连接地址为空`))}async online(){try{this.self_info=await this.api.getSelfInfo(),this.version_info=await this.api.getVersion(),this.uin=this.self_info.id,this.logger.mark(`欢迎 ${this.nickname}(${this.uin})！正在加载资源……`),this.logger.mark(`使用协议 ${this.apk.name}(${this.apk.id}) ${this.apk.version}`),await this.reloadFriendList(),this.config.cache_group_member?await this.reloadGroupMemberList():await this.reloadGroupList(),this.logger.mark(`加载了${this.fl.size}个好友，${this.gl.size}个群，${Array.from(this.gml.values()).reduce((e,d)=>e+d.size,0)}个群成员`),this.api.getSelfCookie().then(e=>this.cookies=e).catch(()=>{}),this.api.getSelfCSRFToken().then(e=>this.bkn=e).catch(()=>{}),await this.api.receiveEvent({event:Handle.event}),this.em(`system.online`)}catch(e){this.em(`system.login.error`,e)}}uploadFile(e){return this.api.uploadCacheFile({file:e})}setOnlineStatus(e=this.status||OnlineStatus.Online){return this.api.setSelfInfo({data:{online_status:e}})}setNickname(e){return this.api.setSelfInfo({data:{name:e}})}setGender(e){return this.api.setSelfInfo({data:{gender:e}})}setBirthday(e){return e=String(e).replace(/[^\d]/g,``),this.api.setSelfInfo({data:{birthday:e}})}setDescription(e=``){return this.api.setSelfInfo({data:{description:e}})}setSignature(e=``){return this.api.setSelfInfo({data:{signature:e}})}getProfile(e){return this.api.getUserInfo({id:e})}setAvatar(e){return this.api.setSelfInfo({data:{avatar:e}})}getRoamingStamp(e=!1){return this.api.getRoamingStamp({refresh:!e})}deleteStamp(e){return this.api.delRoamingStamp({id:e})}getSystemMsg(){return this.api.getRequestArray()}addClass(e){return this.api.addUserClass({name:e})}deleteClass(e){return this.api.delUserClass({name:e})}renameClass(e,d){return this.api.renameUserClass({name:e,new_name:d})}async reloadFriendList(){let e=await this.api.getUserArray({refresh:!0}),d=new Map;for(let f of e)d.set(f.id,{...f,user_id:f.id,nickname:f.name});return this.fl=d}reloadStrangerList(){return this.sl}async reloadGroupList(){let e=await this.api.getGroupArray({refresh:!0}),d=new Map;for(let f of e)d.set(f.id,{...f,group_id:f.id,group_name:f.name});return this.gl=d}async reloadGroupMemberList(){return await Promise.allSettled([...(await this.reloadGroupList()).keys()].map(e=>this.pickGroup(e).getMemberMap(!0))),this.gml}reloadBlackList(){return this.blacklist}cleanCache(){return this.api.clearCache()}getVideoUrl(e){return this.pickFriend(this.uin).getVideoUrl(e)}getForwardMsg(e){return this.pickFriend(this.uin).getForwardMsg(e)}makeForwardMsg(e,d=!1){return(d?this.pickFriend:this.pickGroup)(this.uin).makeForwardMsg(e)}async imageOcr(e){let d=await OICQtoPhilia.prototype._prepareFile({type:`image`,file:e});return this.api.getImageOCR({image:d})}getCookies(e=``){return this.cookies?.[e]}getCsrfToken(){return this.bkn}getFriendList(){return this.fl}getGroupList(){return this.gl}setEssenceMessage(e){return this.api.addGroupEssence({id:e})}removeEssenceMessage(e){return this.api.delGroupEssence({id:e})}getStrangerList(){return this.sl}getStrangerInfo(e){return this.pickUser(e).getSimpleInfo()}getGroupInfo(e,d=!1){let f=this.pickGroup(e);return d?f.renew():f.info||f.renew()}getGroupMemberList(e,d=!1){return this.pickGroup(e).getMemberMap(d)}getGroupMemberInfo(e,d,f=!1){return f||!this.gml.get(e)?.has(d)?this.pickMember(e,d).renew():this.gml.get(e)?.get(d)}sendPrivateMsg(e,d,f){return this.pickFriend(e).sendMsg(d,f)}sendGroupMsg(e,d,f){return this.pickGroup(e).sendMsg(d,f)}sendGroupSign(e){return this.pickGroup(e).sign()}sendTempMsg(e,d,f){return this.pickMember(e,d).sendMsg(f)}deleteMsg(e){return this.api.delMsg({id:e})}reportReaded(e){return this.api.setReaded({id:e})}getMsg(e){return this.api.getMsg({id:e})}getChatHistory(e,d=20){return this.api.getChatHistory({type:`message`,id:e,count:d})}setGroupWholeBan(e,d=!0){return this.pickGroup(e).muteAll(d)}setGroupMemberScreenMsg(e,d,f){return this.pickGroup(e).setScreenMemberMsg(d,f)}setGroupName(e,d){return this.pickGroup(e).setName(d)}sendGroupNotice(e,d){return this.pickGroup(e).announce(d)}setGroupAdmin(e,d,f=!0){return this.pickMember(e,d).setAdmin(f)}setGroupSpecialTitle(e,d,f,p=-1){return this.pickMember(e,d).setTitle(f,p)}setGroupCard(e,d,f){return this.pickMember(e,d).setCard(f)}setGroupKick(e,d,f=!1,p){return this.pickMember(e,d).kick(p,f)}setGroupBan(e,d,f=1800){return this.pickMember(e,d).mute(f)}setGroupLeave(e){return this.pickGroup(e).quit()}sendGroupPoke(e,d){return this.pickMember(e,d).poke()}deleteFriend(e,d=!0){return this.pickFriend(e).delete(d)}inviteFriend(e,d){return this.pickGroup(e).invite(d)}sendLike(e,d=1){return this.pickFriend(e).thumbUp(d)}setPortrait(e){return this.setAvatar(e)}setGroupPortrait(e,d){return this.pickGroup(e).setAvatar(d)}acquireGfs(e){return this.pickGroup(e).fs}setFriendAddRequest(e,d=!0,f=``,p=!1){return this.api.setRequest({id:e,result:d,reason:f,block:p})}setGroupAddRequest(e,d=!0,f=``,p=!1){return this.api.setRequest({id:e,result:d,reason:f,block:p})}em(e=``,d){for(d=Object.defineProperty(d||{},`self_id`,{value:this.uin,writable:!0,enumerable:!0,configurable:!0});;){this.emit(e,d);let f=e.lastIndexOf(`.`);if(f===-1)break;e=e.slice(0,f)}}get online_status(){return this.status}}export function createClient(...e){return new Client(...e)}