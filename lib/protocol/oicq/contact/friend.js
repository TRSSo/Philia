import{hide,lock,timestamp}from"../common.js";import{PrivateMessage,segment}from"../message/index.js";import{Contactable}from"./contactable.js";const weakmap=new WeakMap;export class User extends Contactable{uid;_info;get user_id(){return this.uid}static as(e,r=!1){e=String(e);let i=this.fl.get(e);if(r&&!i)throw Error(`${e}不是你的好友`);let a=weakmap.get(i);return a||(a=new User(this,e,i),i&&weakmap.set(i,a),a)}constructor(i,a,o){super(i),this.uid=a,this._info=o,lock(this,`uid`),hide(this,`_info`)}asFriend(e=!1){return this.c.pickFriend(this.uid,e)}asMember(e,r=!1){return this.c.pickMember(e,this.uid,r)}getAvatarUrl(e=0){return this.info?.avatar||`https://q.qlogo.cn/g?b=qq&s=${e}&nk=${this.uid}`}async thumbUp(e=1){return this.c.api.sendUserLike({id:this.uid,times:e})}async getSimpleInfo(){return this.info}async getChatHistory(e=timestamp(),r=20){let o=(await this.c.api.getChatHistory({type:`user`,id:this.uid,count:1}).catch(()=>[]))[0]?.id;if(!o)return[];let s=[];for(let i=0;i<100;i++){let i=await this.c.api.getChatHistory({type:`message`,id:o,count:11}).catch(()=>[]);o=i.length>1?i.pop()?.id:void 0;for(let o of i)try{if(o.time<=e&&(s.push(await new PrivateMessage(this.c,o).parse()),s.length>=r))return s}catch{}if(!o)break}return s}async markRead(e=timestamp()){return this.c.api.setReaded({id:this.uid,time:e})}async addFriendBack(e,r=``){return this.c.api.addUserBack({id:this.uid,seq:e,remark:r})}async setFriendReq(e,r=!0,i=``,a=!1){let o=await this.c.api.getRequestArray(),s=o.find(r=>r.user?.id===this.uid&&r.raw?.seq===e);if(!s)throw Error(`请求不存在`);let c=await this.c.api.setRequest({id:s.id,result:r,block:a});return i&&this.setRemark(i),c}async setGroupReq(e,r,i=!0,a=``,o=!1){let s=await this.c.api.getRequestArray(),c=s.find(i=>i.user?.id===this.uid&&i.group?.id===e&&i.raw?.seq===r);if(!c)throw Error(`请求不存在`);return this.c.api.setRequest({id:c.id,result:i,reason:a,block:o})}async setGroupInvite(e,r,i=!0,a=!1){let o=await this.c.api.getRequestArray(),s=o.find(i=>i.user?.id===this.uid&&i.group?.id===e&&i.raw?.seq===r);if(!s)throw Error(`请求不存在`);return this.c.api.setRequest({id:s.id,result:i,block:a})}get info(){return this._info}get nickname(){return this.info?.nickname}get sex(){return this.info?.sex}get remark(){return this.info?.remark}get class_id(){return this.info?.class_id}get class_name(){return this.c.classes.get(this.info?.class_id)}async setClass(e){return this.c.api.setUserClass({name:e,id:this.uid})}async poke(e=!1){return this.c.api.sendPoke({scene:`user`,id:this.uid,tid:e?this.c.uin:this.uid})}async delete(e=!0){return this.c.api.delUser({id:this.uid,block:e})}async searchSameGroup(){return(await this.c.api.searchUserSameGroup({id:this.uid})).map(e=>({...e,groupName:e.name,Group_Id:e.id}))}async sendFile(e,r){let i=await this.sendMsg(segment.file(e,r));return i.file_id?.[0]||i.message_id}}export const Friend=User;