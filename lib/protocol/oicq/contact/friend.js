import{hide,lock,timestamp}from"../common.js";import{PrivateMessage,segment}from"../message/index.js";import{Contactable}from"./contactable.js";const weakmap=new WeakMap;export class User extends Contactable{uid;_info;get user_id(){return this.uid}static as(e,i=!1){e=String(e);let a=this.fl.get(e);if(i&&!a)throw Error(`${e}不是你的好友`);let o=weakmap.get(a);return o||(o=new User(this,e,a),a&&weakmap.set(a,o),o)}constructor(a,o,s){super(a),this.uid=o,this._info=s,lock(this,`uid`),hide(this,`_info`)}asFriend(e=!1){return this.c.pickFriend(this.uid,e)}asMember(e,i=!1){return this.c.pickMember(e,this.uid,i)}getAvatarUrl(e=0){return this.info?.avatar||`https://q.qlogo.cn/g?b=qq&s=${e}&nk=${this.uid}`}async thumbUp(e=1){return this.c.api.sendUserLike({id:this.uid,times:e})}async getSimpleInfo(){return this.info}async getChatHistory(e=timestamp(),i=20){let s=(await this.c.api.getChatHistory({type:`user`,id:this.uid,count:1}).catch(()=>[]))[0]?.id;if(!s)return[];let c=[];for(let a=0;a<100;a++){let a=await this.c.api.getChatHistory({type:`message`,id:s,count:11}).catch(()=>[]);s=a.length>1?a.pop()?.id:void 0;for(let s of a)try{if(s.time<=e&&(c.push(await PrivateMessage.deserialize(this.c,s)),c.length>=i))return c}catch{}if(!s)break}return c}async markRead(e=timestamp()){return this.c.api.setReaded({id:this.uid,time:e})}async addFriendBack(e,i=``){return this.c.api.addUserBack({id:this.uid,seq:e,remark:i})}async setFriendReq(e,i=!0,a=``,o=!1){let s=(await this.c.api.getRequestArray()).find(i=>i.user?.id===this.uid&&i.raw?.seq===e);if(!s)throw Error(`请求不存在`);let c=await this.c.api.setRequest({id:s.id,result:i,block:o});return a&&this.setRemark(a),c}async setGroupReq(e,i,a=!0,o=``,s=!1){let c=(await this.c.api.getRequestArray()).find(a=>a.user?.id===this.uid&&a.group?.id===e&&a.raw?.seq===i);if(!c)throw Error(`请求不存在`);return this.c.api.setRequest({id:c.id,result:a,reason:o,block:s})}async setGroupInvite(e,i,a=!0,o=!1){let s=(await this.c.api.getRequestArray()).find(a=>a.user?.id===this.uid&&a.group?.id===e&&a.raw?.seq===i);if(!s)throw Error(`请求不存在`);return this.c.api.setRequest({id:s.id,result:a,block:o})}get info(){return this._info}get nickname(){return this.info?.nickname}get sex(){return this.info?.sex}get remark(){return this.info?.remark}get class_id(){return this.info?.class_id}get class_name(){return this.info?.class_id&&this.c.classes.get(this.info.class_id)}async setClass(e){return this.c.api.setUserClass({name:e,id:this.uid})}async poke(e=!1){return this.c.api.sendPoke({scene:`user`,id:this.uid,tid:e?this.c.uin:this.uid})}async delete(e=!0){return this.c.api.delUser({id:this.uid,block:e})}async searchSameGroup(){return(await this.c.api.searchUserSameGroup({id:this.uid})).map(e=>({...e,groupName:e.name,Group_Id:e.id}))}async sendFile(e,i){let a=await this.sendMsg(segment.file(e,i));return a.file_id?.[0]||a.message_id}}export const Friend=User;