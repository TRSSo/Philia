import{getDateTime}from"#util";import{hide,lock,NOOP,timestamp}from"../common.js";import{GroupMessage,segment}from"../message/index.js";import{Contactable}from"./contactable.js";import{Gfs}from"./gfs.js";const fetchmap=new Map,weakmap=new WeakMap;export class Group extends Contactable{gid;_info;static as(e,c=!1){e=String(e);let l=this.gl.get(e);if(c&&!l)throw Error(`你尚未加入群${e}`);let u=weakmap.get(l);return u||(u=new Group(this,e,l),l&&weakmap.set(l,u),u)}get info(){return(!this._info||timestamp()-this._info?.update_time>=900)&&this.renew().catch(NOOP),this._info}get name(){return this.info?.group_name}get is_owner(){return this.info?.owner_id===this.c.uin}get is_admin(){return this.is_owner||!!this.info?.admin_flag}get all_muted(){return this.info?.shutup_time_whole>timestamp()}get mute_left(){let e=this.info?.shutup_time_me-timestamp();return e>0?e:0}fs;constructor(e,u,d){super(e),this.gid=u,this._info=d,this.fs=new Gfs(e,u),lock(this,`fs`),hide(this,`_info`)}pickMember(e,c=!1){return this.c.pickMember(this.gid,e,c)}getAvatarUrl(e=0,c=0){return this.info?.avatar||`https://p.qlogo.cn/gh/${this.gid}/${this.gid}${c?`_${c}`:``}/${e}`}async renew(){let e=await this.c.api.getGroupInfo({id:this.gid,refresh:!0}),c={group_id:e.id,group_name:e.name,...e};return c=Object.assign(this.c.gl.get(this.gid)||this._info||{},c),this.c.gl.set(this.gid,c),this._info=c,weakmap.set(c,this),c}async _fetchMembers(e){let c=await this.c.api.getGroupMemberArray({id:this.gid,refresh:e}),l=c.map(e=>[e.id,{user_id:e.id,nickname:e.name,...e}]);this.c.gml.set(this.gid,new Map(l)),fetchmap.delete(this.gid);let u=this.c.gml.get(this.gid);return(!u?.size||!this.c.config.cache_group_member)&&this.c.gml.delete(this.gid),u||new Map}getMemberMap(e){let c=fetchmap.get(this.gid);if(c)return c;let l=this.c.gml.get(this.gid);if(!l||e){let c=this._fetchMembers(e);return fetchmap.set(this.gid,c),c}else return l}addEssence(e,c){return typeof e==`number`?this.c.api.addGroupEssence({id:this.gid,seq:e,rand:c}):this.c.api.addGroupEssence({id:e})}removeEssence(e,c){return typeof e==`number`?this.c.api.delGroupEssence({id:this.gid,seq:e,rand:c}):this.c.api.delGroupEssence({id:e})}async sendFile(e,c,l){try{return await this.c.api.uploadGroupFSFile({id:this.gid,file:e,pid:c,name:l})}catch{}let u=await this.sendMsg(segment.file(e,l,c));return{fid:u.file_id?.[0]||u.message_id}}setScreenMemberMsg(e,c){return this.pickMember(e).setScreenMsg(c)}muteAll(e=!0){return this.c.api.setInfo({scene:`group`,id:this.gid,data:{whole_mute:e}})}announce(e){return this.c.api.sendGroupAnnounce({id:this.gid,content:e})}setMessageRateLimit(e){return this.c.api.setMessageRate({id:this.gid,times:e})}async setGroupJoinType(e,c,l){return this.c.api.setGroupJoinType({id:this.gid,type:e,question:c,answer:l})}async setRemark(e=``){return this.c.api.setInfo({scene:`group`,id:this.gid,data:{remark:e}})}getAtAllRemainder(){return this.c.api.getGroupAtAllRemainder({id:this.gid})}markRead(e=0){return typeof e==`number`?this.c.api.setReaded({id:this.gid,seq:e}):this.c.api.setReaded({id:e})}async getChatHistory(e=0,c=20){if(typeof e!=`number`)return this.c.api.getChatHistory({type:`message`,id:e,count:c});let l=(await this.c.api.getChatHistory({type:`group`,id:this.gid,count:1}).catch(()=>[]))[0]?.id;if(!l)return[];let u=[];for(let d=0;d<100;d++){let d=await this.c.api.getChatHistory({type:`message`,id:l,count:11}).catch(()=>[]);l=d.length>1?d.pop()?.id:void 0;for(let l of d)try{if(l.raw?.seq<=e&&(u.push(await new GroupMessage(this.c,l).parse()),u.length>=c))return u}catch{}if(!l)break}return u}invite(e){return this.c.api.sendGroupUserInvite({id:this.gid,uid:e})}sign(){return this.c.api.sendGroupSign({id:this.gid})}quit(){return this.c.api.delGroup({id:this.gid})}setAdmin(e,c=!0){return this.pickMember(e).setAdmin(c)}setTitle(e,c=``,l=-1){return this.pickMember(e).setTitle(c,l)}setCard(e,c=``){return this.pickMember(e).setCard(c)}kickMember(e,c,l=!1){return this.pickMember(e).kick(c,l)}muteMember(e,c=600){return this.pickMember(e).mute(c)}pokeMember(e){return this.pickMember(e).poke()}async getMuteMemberList(){let c=Date.now()/1e3;return(await this.c.api.getGroupMemberArray({id:this.gid})).filter(e=>e.mute_time&&e.mute_time>c).map(c=>({uin:c.id,unMuteTime:getDateTime(new Date(c.mute_time*1e3))}))}setReaction(e,c,l=1){return typeof e==`number`?this.c.api.setReaction({type:`group`,id:this.gid,eid:c,etype:l,seq:e}):this.c.api.setReaction({type:`message`,id:e,eid:c,etype:l})}delReaction(e,c,l=1){return typeof e==`number`?this.c.api.delReaction({type:`group`,id:this.gid,eid:c,etype:l,seq:e}):this.c.api.delReaction({type:`message`,id:e,eid:c,etype:l})}}