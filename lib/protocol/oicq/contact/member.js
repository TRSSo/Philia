import{hide,lock,NOOP,timestamp}from"../common.js";import{User}from"./friend.js";const weakmap=new WeakMap;export class Member extends User{gid;_info;static as(e,n,r=!1){e=String(e),n=String(n);let i=this.gml.get(e)?.get(n);if(r&&!i)throw Error(`群${e}中找不到群员${n}`);let a=weakmap.get(i);return a||(a=new Member(this,e,n,i),i&&weakmap.set(i,a),a)}get info(){return this.c.config.cache_group_member&&(!this._info||timestamp()-this._info?.update_time>=900)&&this.renew().catch(NOOP),this._info}get group_id(){return this.gid}get card(){return this.info?.card||this.info?.nickname}get title(){return this.info?.title}get is_friend(){return this.c.fl.has(this.uid)}get is_owner(){return this.info?.role===`owner`}get is_admin(){return this.info?.role===`admin`||this.is_owner}get mute_left(){let e=this.info?.shutup_time-timestamp();return e>0?e:0}get group(){return this.c.pickGroup(this.gid)}constructor(r,i,a,o){super(r,a),this.gid=i,this._info=o,lock(this,`gid`),hide(this,`_info`)}async renew(){let e=await this.c.api.getGroupMemberInfo({id:this.gid,uid:this.uid,refresh:!0}),n={group_id:this.gid,user_id:e.id,...e};return n=Object.assign(this.c.gml.get(this.gid)?.get(this.uid)||this._info||{},n),this.c.gml.get(this.gid)?.set(this.uid,n),this._info=n,weakmap.set(n,this),n}setAdmin(e=!0){return this.c.api.setGroupMemberInfo({id:this.gid,uid:this.uid,data:{role:e?`admin`:`member`}})}setTitle(e=``,n=-1){return this.c.api.setGroupMemberInfo({id:this.gid,uid:this.uid,data:{title:e,title_expire_time:n}})}async setCard(e=``){return this.c.api.setGroupMemberInfo({id:this.gid,uid:this.uid,data:{card:e}})}async kick(e,n=!1){return this.c.api.delGroupMember({id:this.gid,uid:this.uid,block:n})}async mute(e=1800){return this.c.api.setGroupMemberInfo({id:this.gid,uid:this.uid,data:{mute_time:e}})}async poke(){return this.c.api.sendPoke({scene:`group`,id:this.gid,tid:this.uid})}async setScreenMsg(e=!0){return this.c.api.setGroupMemberInfo({id:this.gid,uid:this.uid,data:{block:e}})}}