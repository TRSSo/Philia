import{lock}from"../common.js";import{GroupMessage,OICQtoPhilia}from"../message/index.js";export class Contactable{c;uid;gid;get target(){return this.uid||this.gid||this.c.uin}get dm(){return!!this.uid}get scene(){return this.dm?`user`:`group`}get client(){return this.c}constructor(t){this.c=t,lock(this,`c`)}get[Symbol.unscopables](){return{c:!0}}shareUrl(e,t){return this.sendMsg({type:`share`,...e,config:t})}shareMusic(e,t){return this.sendMsg({type:`music`,platform:e,id:t})}async uploadImages(e){return Promise.all(e.map(this.uploadImage.bind(this)))}async uploadImage(e){return e.fid?e:{type:`image`,fid:await this.c.uploadFile(e.file)}}async uploadVideo(e){return e.fid?e:{type:`video`,fid:await this.c.uploadFile(e.file)}}async uploadPtt(e,t=!0,n=``){return e.fid?e:{type:`record`,fid:await this.c.uploadFile(e.file),transcoding:t,brief:n}}makeForwardMsg(e){return{type:`node`,data:e}}async getForwardMsg(e){return Promise.all((await this.c.api.getForwardMsg({id:e})).map(e=>(e.user||={},e.group||={},new GroupMessage(this.client,e).parse())))}getVideoUrl(e){return this.getFileUrl(e)}async sendMsg(e,t){let r=new OICQtoPhilia(this,e,t);if(await r.convert(),r.response)return r.response;if(!r.after.length)throw Error(`空消息`);let i=await this.c.api.sendMsg({scene:this.scene,id:this.target,data:r.after});return{message_id:i.id,file_id:i.file_id,time:i.time,rand:i.raw?.rand,seq:i.raw?.seq}}async sendForwardMsg(e){let t=[],r;for(let i of Array.isArray(e)?e:[e]){let e=new OICQtoPhilia(this,i.message);if(await e.convert(),e.response){r??=e.response;continue}if(!e.after.length)continue;t.push({message:e.after,time:i.time,user:{id:i.user_id,name:i.nickname}})}if(t.length){let e=(await this.c.api.sendMultiMsg({scene:this.scene,id:this.target,data:t}))[0];r={message_id:e.id,file_id:e.file_id,time:e.time,rand:e.raw?.rand,seq:e.raw?.seq}}if(!r)throw Error(`空合并转发消息`);return r}async recallMsg(e){return await this.c.api.delMsg({id:typeof e==`string`?e:e.message_id}),!0}forwardMsg(e){return this.c.api.sendMsgForward({scene:this.scene,id:this.target,mid:e})}getFileInfo(e){return this.c.api.getFile({id:e})}async getFileUrl(e){return(await this.getFileInfo(e)).url}recallFile(e){return this.recallMsg(e)}forwardFile(e){return this.sendMsg({type:`file`,fid:e})}setName(e){return this.c.api.setInfo({scene:this.scene,id:this.target,data:{name:e}})}setRemark(e){return this.c.api.setInfo({scene:this.scene,id:this.target,data:{remark:e}})}setAvatar(e){return this.c.api.setInfo({scene:this.scene,id:this.target,data:{avatar:e}})}}