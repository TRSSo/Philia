import fs from"node:fs/promises";import path from"node:path";import{ulid}from"ulid";import{modeMatch}from"#util";export default class PhiliaToTTY{impl;message;summary=``;constructor(e,n){this.impl=e,this.message=Array.isArray(n)?n:[n]}async convert(e=this.message){if(Array.isArray(e))for(let n of e)await this.convert(n);else typeof e==`object`?typeof this[e.type]==`function`?await this[e.type](e):this.text({data:JSON.stringify(e)}):this.text({data:e});return this.summary}text(e){this.summary+=e.data}mention(e){switch(e.data){case`user`:this.summary+=`[提及: ${e.name?`${e.name}(${e.id})`:e.id}]`;break;case`all`:this.summary+=`[提及全体成员]`;break}}reply(e){this.summary+=`[提及: ${e.summary?`${e.summary}(${e.data})`:e.data}]`}button(e){this.summary+=`[按钮: ${JSON.stringify(e.data)}]`}extend(e){this.summary+=`[扩展消息 ${e.extend}: ${JSON.stringify(e.data)}`}async platform(e){modeMatch(e,`tty`)&&await this.convert(e.data)}async file(r,i=`文件`){if(!this.impl.path){this.summary+=r.summary??`[${i}: ${r.name}]`;return}try{switch(r.data){case`id`:return this.file(await this.impl.handle.getFile({id:r.id}));case`binary`:{let a=path.join(this.impl.path,`data`,`${ulid()}-${r.name||`Buffer`}`);typeof r.binary==`string`&&(r.binary=Buffer.from(r.binary.replace(`base64://`,``),`base64`)),await fs.writeFile(a,r.binary),this.summary+=`[${i}: ${a}]`;return}case`url`:return this.file({name:r.name||path.basename(new URL(r.url).pathname),ms:`binary`,binary:await(await fetch(r.url)).arrayBuffer()},i);case`path`:{let a=path.join(this.impl.path,`data`,`${ulid()}-${r.name||path.basename(r.path)}`);await fs.copyFile(r.path,a),this.summary+=`[${i}: ${a}]`;return}}}catch(e){this.impl.logger.error(`${i}保存错误`,r,e)}}image(e){return this.file(e,`图片`)}audio(e){return this.file(e,`音频`)}voice(e){return this.file(e,`语音`)}video(e){return this.file(e,`视频`)}}