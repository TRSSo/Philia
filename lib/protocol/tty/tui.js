import fs from"node:fs/promises";import*as inquirer from"@inquirer/prompts";import{ulid}from"ulid";import YAML from"yaml";import{getLogger}from"#logger";import{clearLine,readLine}from"#util/tui.js";import Impl from"./impl.js";process.on(`SIGINT`,async()=>{await fs.rm(`config.yml`,{force:!0}).catch(()=>{}),process.exit()});export class Tui{config;impl;logger;constructor(e){this.config=e,this.logger=getLogger(`TTY`)}async main(){for(this.impl=new Impl(this.logger,this.config),await this.impl.start();;)try{this.impl.philia.clients.size===0?this.logger.info(`等待客户端连接中`,this.impl.philia.config.path):this.impl.philia.clients.values().next().value.open===!1?this.logger.info(`等待连接到服务端`,this.impl.philia.config.path):await this.send(),await readLine(),clearLine()}catch(e){this.logger.error(`错误`,e)}}async send(){let e=await inquirer.select({message:`Philia TTY`,choices:[{name:`💬 发消息`,value:`sendMsg`},{name:`⚙️ 设置`,value:`setting`},{name:`🔚 退出`,value:`exit`}]});return e===`exit`&&process.exit(),this[e]()}async sendMsg(){let e=await inquirer.input({message:`请输入消息:`}),c={id:ulid(),type:`message`,time:Date.now()/1e3,scene:`user`,user:this.impl.self,message:[{type:`text`,data:e}],summary:e};this.impl.event_message_map.set(c.id,c),this.impl.event_handle.handle(c)}async setting(){for(;;)switch(await inquirer.select({message:`请选择操作`,choices:[{name:`💾 保存配置`,value:`save`},...await fs.stat(`config.yml`).then(()=>[{name:`🗑️ 删除配置`,value:`delete`}]).catch(()=>[]),{name:`🔙 返回`,value:`back`}]})){case`save`:await fs.writeFile(`config.yml`,YAML.stringify(this.config));break;case`delete`:await fs.rm(`config.yml`,{force:!0});break;case`back`:return}}}