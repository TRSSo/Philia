import fs from"node:fs/promises";import{ulid}from"ulid";import{modeMatch}from"#util";import*as OBv11 from"../type/index.js";export class OBv11toPhilia{client;event;before;after=[];summary=``;constructor(e,r){this.client=e,this.event=r,this.before=Array.isArray(r.message)?r.message:[r.message]}async convert(){for(let e of this.before)typeof e==`object`?typeof this[e.type]==`function`?await this[e.type](e):OBv11.Message.ExtendArray.includes(e.type)?this.extend(e):this._text(e):this._text(e);return this}extend(e){this.after.push({type:`extend`,extend:`OneBotv11.${e.type}`,data:e}),this.summary+=`[${e.type}: ${e}]`}_text(e,r){let i={type:`text`,data:String(e)};i.data.length&&(r&&(i.markdown=r),this.after.push(i),this.summary+=i.data)}text(e){this._text(e.data.text)}async at(e){let{qq:r,name:i=``}=e.data;switch(r){case`user`:if(r=String(r),!i){let e;this.event.message_type===`group`&&(e=await this.client.handle.getGroupMemberInfo({id:String(this.event.group_id),uid:r})),e??=await this.client.handle.getUserInfo({id:r}),e&&(i=e.card||e.name)}this.summary+=`[提及: ${i}(${r})]`,this.after.push({type:`mention`,data:`user`,id:r,name:i});break;case`all`:this.summary+=`[提及全体成员]`,this.after.push({type:`mention`,data:`all`});break}}async _prepareFile(i){let a={type:i.type,id:ulid(),data:`binary`,name:i.name};if(i.data.url)a.data=`url`,a.url=i.data.url,a.name=i.data.file;else if(Buffer.isBuffer(i.data.file))a.binary=i.data.file;else if(i.data.file.startsWith(`base64://`))a.binary=Buffer.from(i.data.file.replace(`base64://`,``),`base64`);else if(i.data.file.match(/^https?:\/\//))a.data=`url`,a.url=i.data.file;else{let r=i.data.file.replace(/^file:\/\//,``);await fs.stat(r).catch(()=>!1)?a.binary=await fs.readFile(r):(a.data=`path`,a.path=r)}return a}async image(e){this.after.push(await this._prepareFile(e)),this.summary+=`[图片]`}async record(e){this.after.push(await this._prepareFile({...e,type:`voice`})),this.summary+=`[语音]`}async video(e){this.after.push(await this._prepareFile(e)),this.summary+=`[视频]`}async forward(e){for(let r of await this.client.handle.getForwardMsg({id:e.data.id}))this.after.push(...r.message)}reply(e){this.after.push({type:`reply`,data:e.data.id,summary:e.data.text}),this.summary+=`[提及: ${e.data.text?`${e.data.text}(${e.data.id})`:e.data.id}]`}}export class PhiliaToOBv11{client;scene;id;before;after=[];summary=``;constructor(e,r,i,a){this.client=e,this.scene=r,this.id=i,this.before=Array.isArray(a)?a:[a]}async convert(){for(let e of this.before)typeof e==`object`&&typeof this[e.type]==`function`?await this[e.type](e):this._text(e);return this}_text(e){e=String(e),e.length&&(this.after.push({type:`text`,data:{text:e}}),this.summary+=e)}text(e){this._text(e.data)}mention(e){switch(e.data){case`user`:this.after.push({type:`at`,data:{qq:e.id,name:e.name}}),this.summary+=e.name?`@${e.name}(${e.id})`:`@${e.id}`;break;case`all`:this.after.push({type:`at`,data:{qq:`all`}}),this.summary+=`@全体成员`;break}}reply(e){this.after.push({type:`reply`,data:{id:e.data,text:e.summary}}),this.summary+=e.summary?`[回复: ${e.summary}(${e.data})]`:`[回复: ${e.data}]`}extend(e){if(!e.extend.startsWith(`OneBotv11.`))return;let r=e.extend.replace(`OneBotv11.`,``);OBv11.Message.ExtendArray.includes(r)&&(this.after.push(e.data),this.summary+=`[${e.data.type}: ${e.data}]`)}platform(e){this.summary+=`[${e.list}(${e.mode}) 平台消息: ${e.data}]`,modeMatch(e,`OneBotv11`)&&(Array.isArray(e.data)?this.after.push(...e.data):this.after.push(e.data))}_file(e,r){switch(r.data){case`id`:case`path`:this.after.push({type:e,data:{file:r.id||r.path}});break;case`binary`:this.after.push({type:e,data:{file:r.binary}});break;case`url`:this.after.push({type:e,data:{file:r.url}});break}}async file(e){await this.client.handle._sendFile({scene:this.scene,id:this.id,data:e}),this.summary+=e.summary??`[文件: ${e.name}]`}image(e){this._file(`image`,e),this.summary+=e.summary??`[图片: ${e.name}]`}voice(e){this._file(`record`,e),this.summary+=e.summary??`[语音: ${e.name}]`}async audio(e){await this.client.handle._sendFile({scene:this.scene,id:this.id,data:e}),this.summary+=e.summary??`[音频: ${e.name}]`}video(e){this._file(`video`,e),this.summary+=e.summary??`[视频: ${e.name}]`}button(){}}