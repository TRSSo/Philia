import{ulid}from"ulid";import{modeMatch}from"#util";import*as Milky from"../type/index.js";import*as Common from"./common.js";export class MilkyToPhilia{impl;event;before;after=[];summary=``;constructor(e,r){this.impl=e,this.event=r,this.before=Array.isArray(r.segments)?r.segments:[r.segments]}async convert(){for(let e of this.before)typeof e==`object`?typeof this[e.type]==`function`?await this[e.type](e):Milky.Message.IncomingExtendArray.includes(e.type)?this.extend(e):this._text(e):this._text(e);return this}extend(e){this.after.push({type:`extend`,extend:`Milky.${e.type}`,data:e}),this.summary+=`[${e.type}: ${e}]`}_text(e,r){let i={type:`text`,data:String(e)};i.data.length&&(r&&(i.markdown=r),this.after.push(i),this.summary+=i.data)}text(e){this._text(e.data.text)}mention(e){this.after.push({type:`mention`,data:`user`,id:String(e.data.user_id)}),this.summary+=`@${e.data.user_id}`}mention_all(){this.after.push({type:`mention`,data:`all`}),this.summary+=`@全体成员`}reply(e){this.after.push({type:`reply`,data:Common.encodeMessageID(this.event.message_scene,this.event.peer_id,e.data.message_seq)})}image(r){this.after.push({type:`image`,name:ulid(),data:r.data.temp_url?`url`:`id`,url:r.data.temp_url,id:Common.encodeFileID(0,r.data.resource_id),summary:r.data.summary,raw:r.data})}record(r){this.after.push({type:`voice`,name:ulid(),data:r.data.temp_url?`url`:`id`,url:r.data.temp_url,id:Common.encodeFileID(0,r.data.resource_id),raw:r.data})}video(r){this.after.push({type:`video`,name:ulid(),data:r.data.temp_url?`url`:`id`,url:r.data.temp_url,id:Common.encodeFileID(0,r.data.resource_id)})}}export class PhiliaToMilky{impl;scene;id;before;after=[];summary=``;file_id;constructor(e,r,i,a){this.impl=e,this.scene=r,this.id=i,this.before=Array.isArray(a)?a:[a]}async convert(){for(let e of this.before)typeof e==`object`&&typeof this[e.type]==`function`?await this[e.type](e):this._text(e);return this}_text(e){e=String(e),e.length&&(this.after.push({type:`text`,data:{text:e}}),this.summary+=e)}text(e){this._text(e.data)}mention(e){switch(e.data){case`user`:this.after.push({type:`mention`,data:{user_id:+e.id}}),this.summary+=`[提及: ${e.id}]`;break;case`all`:this.after.push({type:`mention_all`,data:{}}),this.summary+=`[提及全体成员]`;break}}reply(e){let{message_seq:r}=Common.decodeMessageID(e.data);this.after.push({type:`reply`,data:{message_seq:r}}),this.summary+=e.summary?`[回复: ${e.summary}(${e.data})]`:`[回复: ${e.data}]`}extend(e){if(!e.extend.startsWith(`Milky.`))return;let r=e.extend.replace(`Milky.`,``);Milky.Message.OutgoingExtendArray.includes(r)&&(this.after.push(e.data),this.summary+=`[${e.data.type}: ${e.data}]`)}platform(e){this.summary+=`[${e.list}(${e.mode}) 平台消息: ${e.data}]`,modeMatch(e,`Milky`)&&(Array.isArray(e.data)?this.after.push(...e.data):this.after.push(e.data))}async _file(e,r){let i;switch(r.data){case`id`:i={type:e,data:{uri:(await this.impl.handle.getFile({id:r.id})).url}};break;case`path`:i={type:e,data:{uri:r.path}};break;case`binary`:i={type:e,data:{uri:Buffer.isBuffer(r.binary)?`base64://${r.binary.toString(`base64`)}`:r.binary}};break;case`url`:i={type:e,data:{uri:r.url}};break}return this.after.push(i),i}async file(e){let r=await this.impl.handle._sendFile({scene:this.scene,id:this.id,data:e});this.file_id??=[],this.file_id.push(r),this.summary+=e.summary??`[文件: ${e.name}]`}async image(e){let r=await this._file(`image`,e);e.summary&&(r.data.summary=e.summary),r.data.sub_type=`normal`,this.summary+=e.summary??`[图片: ${e.name}]`}async voice(e){await this._file(`record`,e),this.summary+=e.summary??`[语音: ${e.name}]`}audio(e){return this.file({...e,summary:e.summary??`[音频: ${e.name}]`})}async video(e){await this._file(`video`,e),this.summary+=e.summary??`[视频: ${e.name}]`}button(){}}