import fs from"node:fs/promises";import Path from"node:path";import*as inquirer from"@inquirer/prompts";import YAML from"yaml";import{getProjectDir}from"#util";import{selectArray,sendInfo}from"#util/tui.js";import ProjectManagerTui from"./manager/tui.js";import*as Project from"./project/index.js";export default class Tui{logger;impl_path=getProjectDir(`Impl`);app_path=getProjectDir(`App`);constructor(e){this.logger=e}async main(){for(;;)try{let e=await this.list(),i=Symbol(`create`),o=Symbol(`exit`),s=await inquirer.select({message:`æ¬¢è¿Žä½¿ç”¨ Philia é¡¹ç›®ç®¡ç†å™¨`,choices:[...e,{name:`ðŸ†• åˆ›å»ºé¡¹ç›®`,value:i},{name:`ðŸ”š é€€å‡º`,value:o}],pageSize:e.length+2});switch(s){case i:await this.create();break;case o:this.exit();break;default:await new ProjectManagerTui(this.logger,s).main()}}catch(e){e?.name!==`ExitPromptError`&&this.logger.error(e),await sendInfo()}}async list(){let o=[],s=await fs.readdir(this.impl_path).catch(()=>[]);if(s.length){o.push(new inquirer.Separator(`â”€â”€â”€â”€å®žçŽ°ç«¯â”€â”€â”€â”€`));for(let e of s)o.push({name:`${o.length+1}. ${e}`,value:Path.join(this.impl_path,e)})}let c=await fs.readdir(this.app_path).catch(()=>[]);if(c.length){o.push(new inquirer.Separator(`â”€â”€â”€â”€åº”ç”¨ç«¯â”€â”€â”€â”€`));for(let e of c)o.push({name:`${o.length+1}. ${e}`,value:Path.join(this.app_path,e)})}return o.length&&o.push(new inquirer.Separator(`â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€`)),o}async create(){let s=await inquirer.select({message:`è¯·é€‰æ‹© Philia ç±»åž‹`,choices:[{name:`å®žçŽ°ç«¯`,value:`impl`},{name:`åº”ç”¨ç«¯`,value:`app`}]}),l=Object.keys(Project[s]);if(!l.length)return sendInfo(`æ²¡æœ‰å¯åˆ›å»ºé¡¹ç›®`);let u=await inquirer.select({message:`é€‰æ‹©åˆ›å»ºé¡¹ç›®`,choices:selectArray(l)}),d=(await Project[s][u]()).Project,f=await d.createConfig(u),p=await inquirer.input({message:`è¯·è¾“å…¥é¡¹ç›®å:`,validate:async a=>Path.basename(a)===a?await fs.stat(Path.join(this[`${s}_path`],a)).catch(()=>!1)?`é¡¹ç›®å·²å­˜åœ¨`:!0:`è¾“å…¥æ— æ•ˆ`,required:!0,default:f.name});p=Path.join(this[`${s}_path`],p),await fs.mkdir(p,{recursive:!0});let m=process.cwd();try{process.chdir(p),new d(f),await fs.writeFile(`config.yml`,YAML.stringify(f))}catch(i){throw await fs.rm(process.cwd(),{recursive:!0}),i}finally{process.chdir(m)}await new ProjectManagerTui(this.logger,p).main()}exit(){process.exit()}}