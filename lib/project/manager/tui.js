import child_process from"node:child_process";import fs from"node:fs/promises";import Path from"node:path";import{setTimeout}from"node:timers/promises";import*as inquirer from"@inquirer/prompts";import{Client as SocketClient}from"#connect/socket";import{createAPI}from"#protocol/common";import{chalk,getCodeDir,getDateTime,getTime}from"#util";import{less,lessZstd,selectArray,sendInfo}from"#util/tui.js";import*as type from"./type.js";export default class ProjectManagerTui{logger;path;name;client;api;constructor(e,u){this.logger=e,this.path=u,this.name=Path.basename(this.path),this.client=new SocketClient(e,{}),this.api=createAPI(this.client)}async main(){for(await this.connect().catch(()=>{});;)try{let e=await(this.client.open?this.openMenu():inquirer.select({message:`${this.name} é¡¹ç›®ç®¡ç†`,choices:[{name:`â–¶ï¸ å¯åŠ¨`,value:`start`},{name:`ğŸ“ æ—¥å¿—`,value:`log`},{name:`âš™ï¸ è®¾ç½®`,value:`setting`},{name:`ğŸ“Œ å‰å°`,value:`foreground`},{name:`ğŸ—‘ï¸ åˆ é™¤`,value:`delete`},{name:`ğŸ”™ è¿”å›`,value:`back`}]}));if(e&&await this[e]()===!1)break}catch(e){e?.name!==`ExitPromptError`&&this.logger.error(e),await sendInfo()}this.client.close().catch(()=>{})}async openMenu(){let e=await this.checkNotice(),u=[];e!==0&&u.push({name:`ğŸ”” é€šçŸ¥${typeof e==`object`?`: ${e.name}`:`(${e})`}`,value:`notice`});let d=new AbortController;return this.client.handle.setOnce(`newNotice`,()=>d.abort()),inquirer.select({message:`${this.name} é¡¹ç›®è¿è¡Œä¸­`,choices:[...u,{name:`ğŸ“ æ—¥å¿—`,value:`log`},{name:`â¹ï¸ åœæ­¢`,value:`stop`},{name:`ğŸ”™ è¿”å›`,value:`back`}]},{signal:d.signal}).catch(e=>{if(!d.signal.aborted)throw e})}connect(){return this.client.connect(`${Path.resolve(this.path)}/Manager`,0)}async checkNotice(){let e=await this.api.countNotice();return e===1?(await this.api.listNotice())[0]:e}async handleNotice(e){let u=await inquirer.select({message:e.desc,choices:[e.input?{name:`ğŸ“¥ å¤„ç†`,value:`handle`}:{name:`âœ… å®Œæˆ`,value:`done`},{name:`ğŸ”™ è¿”å›`,value:`back`}]}),d;switch(u){case`back`:return!1;case`handle`:d=await inquirer.input({message:`è¯·è¾“å…¥æ•°æ®:`,required:!0})}let f=await this.api.handleNotice({id:e.id,data:d});f&&await sendInfo(`å¤„ç†ç»“æœ: ${f}`)}async notice(e){for(e??=await this.api.listNotice();e.length;e=await this.api.listNotice()){if(e.length===1){if(await this.handleNotice(e[0])===!1)break;continue}let u=Symbol(`back`),d=await inquirer.select({message:`é€šçŸ¥åˆ—è¡¨`,choices:[...selectArray(e.map(({name:e},u)=>[u,e]),e.map(({desc:e})=>e)),{name:`ğŸ”™ è¿”å›`,value:u}]});if(d===u)break;await this.handleNotice(e[d])}}async followLog(e,u=-1,d=Promise.withResolvers()){if(u===-1){let e=await this.checkNotice();e&&(typeof e==`object`?(this.logger.info(`æ”¶åˆ°æ–°é€šçŸ¥: ${e.name}`),await this.notice([e])):await this.notice())}else{let e=await this.api.listNotice();e.length&&(this.logger.info(`æ”¶åˆ°æ–°é€šçŸ¥: ${e[e.length-1].name}`),await this.notice(e))}let f=`receiveLog`;this.client.handle.set(f,e=>process.stdout.write(this.printLog(e)));let p=new AbortController;return this.client.handle.setOnce(`newNotice`,()=>p.abort()),inquirer.confirm({message:`æ­£åœ¨ç›‘å¬å®æ—¶æ—¥å¿—ï¼ŒæŒ‰å›è½¦é”®ç»“æŸ`},{signal:p.signal}).then(()=>p.signal.aborted||d.resolve(),e=>p.signal.aborted||d.reject(e)).finally(()=>{this.api.unfollowLog(),this.client.handle.del(f),p.signal.aborted&&this.followLog(e,Date.now(),d).catch(d.reject)}),process.stdout.write(`
`),await this.getLog({level:e,time:u,...u===-1?{lines:10}:{}}),await this.api.followLog({level:e,handle:f}),d.promise}printLog(e){let u=getTime(new Date(e.time)),d=type.LoggerLevel[e.level];return`${chalk[type.LoggerLevelColor[d]](`[${u}][${d.slice(0,4)}]`)}${e.name} ${e.data.join(` `)}\n`}async getLog(e){let u=await this.api.getLog(e);if(!u.length)return;let d=``;for(let e of u)d+=this.printLog(e);return process.stdout.write(d),u[u.length-1]}async requestLog(e){if(!e.lines||e.time&&e.time<0)return this.getLog(e);let u=e.time,d;for(;d=await this.getLog({...e,time:u});){if(!await inquirer.confirm({message:`å¾€ä¸‹æŸ¥çœ‹${e.lines}æ¡æ—¥å¿—`}))return;u=d.time+1}if(await inquirer.confirm({message:`æ²¡æœ‰æ—¥å¿—äº†ï¼Œç›‘å¬å®æ—¶æ—¥å¿—?`}))return this.followLog(e.level,u)}async fileLog(e=!1){let f=Path.join(this.path,`Log`),p=Symbol(`back`);for(;;){let m=await fs.readdir(f).catch(e=>{if(e.code===`ENOENT`)return[];throw e}),h=await inquirer.select({message:`é€‰æ‹©æ—¥å¿—åˆ†ç±»`,choices:[...selectArray(m),{name:`ğŸ”™ è¿”å›`,value:p}]});if(h===p)break;let g=Path.join(f,h);for(;;){let f=await fs.readdir(g).catch(e=>{if(e.code===`ENOENT`)return[];throw e}),m=await inquirer.select({message:`é€‰æ‹©æ—¥å¿—æ–‡ä»¶`,choices:[...selectArray(f),{name:`ğŸ”™ è¿”å›`,value:p}]});if(m===p)break;let h=Path.join(g,m);await(m.endsWith(`.zst`)?lessZstd(h):less(h,e))}}}async log(){if(!this.client.open)return this.fileLog();let e=await inquirer.select({message:`è¯·é€‰æ‹©æŸ¥çœ‹ç±»å‹`,choices:[{name:`â±ï¸ å®æ—¶æ—¥å¿—`,value:`now`},{name:`ğŸ“œ å†å²æ—¥å¿—`,value:`history`},{name:`ğŸ“„ æ–‡ä»¶æ—¥å¿—`,value:`file`}]});if(e===`file`)return this.fileLog(!0);let u=type.LoggerLevel[await inquirer.select({message:`è¯·é€‰æ‹©æ—¥å¿—ç­‰çº§`,choices:selectArray(Object.keys(type.LoggerLevelColor))})];if(e===`now`)return this.followLog(u);let d=await inquirer.number({message:`è¯·è¾“å…¥è·å–è¡Œæ•°:`,default:10,min:1}),f=await inquirer.input({message:`è¯·è¾“å…¥å¼€å§‹æ—¶é—´:`,default:getDateTime(new Date(Date.now()-6e5)),validate(e){return e&&Number.isNaN(Date.parse(e))?`æ—¶é—´æ ¼å¼é”™è¯¯`:!0}});await this.requestLog({level:u,lines:d,time:f?Date.parse(f):void 0})}async start(){let u=child_process.spawn(process.execPath,[Path.join(getCodeDir(),`bin`,`run`),this.path],{detached:!0});u.stdout.pipe(process.stdout),u.stderr.pipe(process.stderr);for(let e=0;e<30;e++)try{if(await setTimeout(500),u.exitCode!==null)break;if(await this.connect(),this.client.open)return await this.api.closeConsole(),u.stdin.end(),u.stdout.destroy(),u.stderr.destroy(),u.unref(),sendInfo(`å¯åŠ¨å®Œæˆ`)}catch{}return u.kill(`SIGKILL`),sendInfo(`å¯åŠ¨é”™è¯¯(${u.exitCode})`)}foreground(){try{return process.execve(process.execPath,[process.execPath,Path.join(getCodeDir(),`bin`,`run`),this.path],process.env)}catch{}return child_process.spawnSync(process.execPath,[Path.join(getCodeDir(),`bin`,`run`),this.path],{stdio:`inherit`})}async stop(){await this.api.stop();let e=Promise.withResolvers();return this.client.closed_fn=e.resolve,e.promise}setting(){}async delete(){if(await inquirer.confirm({message:`æ˜¯å¦åˆ é™¤é¡¹ç›®?`}))return await fs.rm(this.path,{recursive:!0}),!1}back(){return!1}}